<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ECU Map Studio 2026</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        :root { --accent: #0078d4; --bg: #1e1e1e; --panel: #252526; --border: #3c3c3c; --text: #cccccc; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        #toolbar { background: #2d2d30; padding: 0; border-bottom: 1px solid var(--border); display: flex; align-items: center; height: 40px; }
        .toolbar-btn { 
            background: transparent; 
            border: none; 
            color: var(--text); 
            padding: 8px 16px; 
            cursor: pointer; 
            font-size: 18px;
            height: 100%;
            border-right: 1px solid var(--border);
            transition: background 0.2s;
            position: relative;
        }
        .toolbar-btn:hover { background: #3e3e42; }
        .toolbar-btn:active { background: #007acc; }
        .toolbar-btn.active { background: #007acc; }
        .toolbar-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .toolbar-btn:disabled:hover {
            background: transparent;
        }
        .toolbar-btn.ecu-disconnected {
            background: #8b0000;
        }
        .toolbar-btn.ecu-disconnected:hover {
            background: #a52a2a;
        }
        .toolbar-btn.ecu-connected {
            background: #006400;
        }
        .toolbar-btn.ecu-connected:hover {
            background: #228b22;
        }
        .toolbar-separator {
            width: 1px;
            height: 100%;
            background: var(--border);
            margin: 0 4px;
        }
        .toolbar-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 100%;
            left: 0;
            background: #1e1e1e;
            color: #fff;
            padding: 6px 10px;
            border-radius: 3px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            border: 1px solid var(--border);
            z-index: 10000;
            margin-top: 5px;
        }
        .toolbar-btn:hover::after { opacity: 1; }
        .toolbar-title { padding: 0 16px; font-size: 12px; color: #888; margin-left: auto; }
        
        .hamburger-menu { 
            background: transparent; 
            border: none; 
            color: var(--text); 
            padding: 8px 16px; 
            cursor: pointer; 
            font-size: 20px;
            height: 100%;
            border-left: 1px solid var(--border);
            transition: background 0.2s;
        }
        .hamburger-menu:hover { background: #3e3e42; }
        .hamburger-menu.active { background: #007acc; }
        
        #settings-menu {
            position: fixed;
            top: 40px;
            right: 0;
            width: 300px;
            background: var(--panel);
            border: 1px solid var(--border);
            box-shadow: 0 4px 16px rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            padding: 15px;
        }
        #settings-menu.active { display: block; }
        #settings-menu h3 { margin: 0 0 15px 0; font-size: 14px; color: var(--accent); }
        .setting-item { margin-bottom: 15px; }
        .setting-item label { display: block; font-size: 12px; color: var(--text); margin-bottom: 5px; }
        .setting-item select {
            width: 100%;
            background: #3c3c3c;
            color: var(--text);
            border: 1px solid var(--border);
            padding: 5px;
            font-size: 12px;
        }

        #main-container { display: flex; flex: 1; overflow: hidden; }
        #explorer { width: 220px; background: var(--panel); border-right: 1px solid var(--border); font-size: 13px; flex-shrink: 0; }
        .explorer-header { padding: 10px; font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase; }
        .tree-item { padding: 4px 20px; cursor: pointer; display: flex; align-items: center; white-space: nowrap; }
        .tree-item:hover { background: #2a2d2e; }
        .tree-item.active { background: #37373d; color: #fff; border-left: 2px solid var(--accent); }
        .tree-icon { margin-right: 8px; font-size: 14px; }
        #content-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        #map-section { flex: 1; overflow: auto; background: #000; position: relative; }
        
        #info-section { height: 120px; background: var(--panel); border-top: 1px solid var(--border); padding: 15px; font-size: 12px; overflow-y: auto; }
        #info-section h3 { margin: 0 0 10px 0; font-size: 11px; color: #888; text-transform: uppercase; }
        #info-content { color: var(--text); }
        
        #graph-overlay { 
            position: fixed; 
            top: 69px;
            right: 20px; 
            width: 400px; 
            height: 300px; 
            background: var(--panel); 
            border: 1px solid var(--border); 
            box-shadow: 0 8px 32px rgba(0,0,0,0.5); 
            z-index: 1000;
            display: none;
            flex-direction: column;
            resize: both;
            overflow: auto;
            min-width: 300px;
            min-height: 200px;
        }
        #graph-overlay.active { display: flex; }
        #graph-header { 
            background: #2d2d30; 
            padding: 8px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 1px solid var(--border);
            cursor: move;
            flex-shrink: 0;
            z-index: 1;
            position: relative;
        }
        #graph-close { 
            background: transparent; 
            border: none; 
            color: var(--text); 
            font-size: 20px; 
            cursor: pointer; 
            padding: 0 8px;
            line-height: 1;
        }
        #graph-close:hover { color: #fff; background: #e81123; }
        #graph-body { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            padding: 10px; 
            position: relative; 
            z-index: 1;
            pointer-events: none;
        }
        #chart-container { 
            flex: 1; 
            min-height: 0; 
            position: relative; 
            z-index: 0; 
            pointer-events: auto; 
        }
        
        #table-wrapper { position: relative; min-height: 100%; }
        
        .header-row { 
            position: sticky; 
            top: 0; 
            z-index: 150; 
            display: grid; 
            grid-template-columns: 80px repeat(20, 60px); 
            gap: 1px; 
            background: var(--border);
            width: max-content;
        }
        
        .grid-container { display: grid; grid-template-columns: 80px repeat(20, 60px); gap: 1px; background: var(--border); width: max-content; isolation: isolate; }
        
        .cell { height: 28px; display: flex; align-items: center; justify-content: center; position: relative; background: #1a1a1a; box-sizing: border-box; border: 1px solid transparent; }
        .header-cell { background: #2d2d2d !important; color: #fff; font-size: 10px; height: 28px; box-sizing: border-box; }
        .header-cell.selected-header { background: #4a4a4a !important; color: #fff; }
        .label-cell { 
            background: #2d2d2d !important; 
            font-size: 10px; 
            position: sticky; 
            left: 0; 
            z-index: 200;
            border-right: 2px solid var(--border); 
            border-bottom: 1px solid var(--border);
            width: 80px;
            height: 28px;
            box-sizing: border-box;
        }
        .label-cell.selected-label { background: #4a4a4a !important; color: #fff; }
        .corner-cell { z-index: 250; position: sticky; left: 0; width: 80px; }
        
        .cell input { width: 100%; height: 100%; border: none; text-align: center; background: transparent; font-size: 12px; outline: none; position: relative; z-index: 1; }
        .cell input::-webkit-outer-spin-button,
        .cell input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .cell input[type=number] {
            -moz-appearance: textfield;
        }
        .cell input {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .cell input.diff-mode { color: #000; }
        .cell input.heatmap-mode { color: #fff; }
        .selected-cell { position: relative; }
        .selected-cell::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid var(--accent);
            pointer-events: none;
            z-index: 2;
            box-sizing: border-box;
        }
        .multi-selected-cell::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 120, 212, 0.3);
            border: 1px solid var(--accent);
            pointer-events: none;
            z-index: 2;
            box-sizing: border-box;
        }
        .cross-highlight::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 0, 0.15); pointer-events: none; z-index: 1; }

        /* ã‚»ãƒ«ç·¨é›†ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
        #cell-popup {
            position: fixed;
            background: var(--panel);
            border: 1px solid var(--accent);
            box-shadow: 0 4px 12px rgba(0,0,0,0.6);
            padding: 10px;
            z-index: 500;
            display: none;
            min-width: 120px;
            font-size: 12px;
        }
        #cell-popup.active { display: block; }
        .popup-mode-selector {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }
        .popup-mode-btn {
            flex: 1;
            background: #3c3c3c;
            color: var(--text);
            border: 1px solid var(--border);
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
        }
        .popup-mode-btn.active {
            background: var(--accent);
            color: #fff;
        }
        .popup-mode-btn:hover { background: #4c4c4c; }
        .popup-mode-btn.active:hover { background: #0087e8; }
        .popup-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
        }
        .popup-btn {
            background: #3c3c3c;
            color: var(--text);
            border: 1px solid var(--border);
            padding: 6px 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            opacity: 1;
        }
        .popup-btn:hover { background: #4c4c4c; }
        .popup-input {
            width: 60px;
            background: #3c3c3c;
            color: var(--text);
            border: 1px solid var(--border);
            padding: 4px;
            text-align: center;
            font-size: 12px;
        }
    </style>
</head>
<body>

<div id="toolbar">
    <button class="toolbar-btn" data-tooltip="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã (Ctrl+O)" onclick="openFile()">ğŸ“</button>
    <button class="toolbar-btn" data-tooltip="åŸºæº–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã (Ctrl+Shift+O)" onclick="openBaseFile()">ğŸ“‹</button>
    <button class="toolbar-btn" data-tooltip="ä¿å­˜ (Ctrl+S)" onclick="saveFile()">ğŸ’¾</button>
    
    <div class="toolbar-separator"></div>
    
    <button class="toolbar-btn" data-tooltip="å…ƒã«æˆ»ã™ (Ctrl+Z)" onclick="undo()" id="btn-undo">â†¶</button>
    <button class="toolbar-btn" data-tooltip="ã‚„ã‚Šç›´ã— (Ctrl+Y)" onclick="redo()" id="btn-redo">â†·</button>
    
    <div class="toolbar-separator"></div>
    
    <button class="toolbar-btn ecu-disconnected" data-tooltip="ECUã«æ¥ç¶š" onclick="toggleECUConnection()" id="btn-ecu-connect">ğŸ“¡</button>
    <button class="toolbar-btn" data-tooltip="ECUã«æ›¸ãè¾¼ã¿ (Ctrl+W)" onclick="writeToECU()" id="btn-write" disabled>ğŸ“¤</button>
    <button class="toolbar-btn" data-tooltip="ECUã‹ã‚‰èª­ã¿å–ã‚Š (Ctrl+R)" onclick="readFromECU()" id="btn-read" disabled>ğŸ“¥</button>
    
    <div class="toolbar-separator"></div>
    
    <button class="toolbar-btn" data-tooltip="ã‚°ãƒ©ãƒ•è¡¨ç¤º (Ctrl+G)" onclick="toggleGraph()" id="btn-graph">ğŸ“Š</button>
    
    <span class="toolbar-title">ECU Map Studio - Kitaco S3 v1.0</span>
    <button class="hamburger-menu" onclick="toggleSettings()" id="btn-settings">â˜°</button>
</div>

<div id="settings-menu">
    <h3>âš™ï¸ è¨­å®š</h3>
    <div class="setting-item">
        <label>ã‚»ãƒ«æ•°å€¤ã®è‰²è¡¨ç¤º:</label>
        <select id="cell-color-mode" onchange="updateCellColorMode()">
            <option value="diff">å·®åˆ†è¡¨ç¤ºï¼ˆç·¨é›†: èµ¤/é’ï¼‰</option>
            <option value="heatmap">ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼ˆé’â†’ç·‘â†’èµ¤ï¼‰</option>
        </select>
    </div>
</div>

<div id="graph-overlay">
    <div id="graph-header">
        <select id="graph-type" onchange="updateGraph()">
            <option value="3d">3D: Surface</option>
            <option value="rpm">2D: vs RPM (Fix TPS)</option>
            <option value="tps">2D: vs TPS (Fix RPM)</option>
        </select>
        <button id="graph-close" onclick="toggleGraph()">Ã—</button>
    </div>
    <div id="graph-body">
        <div id="chart-container"></div>
    </div>
    
    <div class="resize-handle resize-n" style="position: absolute; top: 0; left: 0; right: 0; height: 15px; cursor: ns-resize; z-index: 999999;"></div>
    <div class="resize-handle resize-s" style="position: absolute; bottom: 0; left: 0; right: 0; height: 15px; cursor: ns-resize; z-index: 999999;"></div>
    <div class="resize-handle resize-e" style="position: absolute; right: 0; top: 0; bottom: 0; width: 15px; cursor: ew-resize; z-index: 999999;"></div>
    <div class="resize-handle resize-w" style="position: absolute; left: 0; top: 0; bottom: 0; width: 15px; cursor: ew-resize; z-index: 999999;"></div>
    <div class="resize-handle resize-ne" style="position: absolute; top: 0; right: 0; width: 25px; height: 25px; cursor: nesw-resize; z-index: 999999;"></div>
    <div class="resize-handle resize-nw" style="position: absolute; top: 0; left: 0; width: 25px; height: 25px; cursor: nwse-resize; z-index: 999999;"></div>
    <div class="resize-handle resize-se" style="position: absolute; bottom: 0; right: 0; width: 25px; height: 25px; cursor: nwse-resize; z-index: 999999;"></div>
    <div class="resize-handle resize-sw" style="position: absolute; bottom: 0; left: 0; width: 25px; height: 25px; cursor: nesw-resize; z-index: 999999;"></div>
</div>

<input type="file" id="file-input" style="display:none" onchange="importFromCSV(this)">
<input type="file" id="base-file-input" style="display:none" onchange="importBaseFromCSV(this)">

<!-- ã‚»ãƒ«ç·¨é›†ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
<div id="cell-popup">
    <div class="popup-mode-selector">
        <button class="popup-mode-btn active" id="mode-abs" onclick="switchPopupMode('abs')">çµ¶å¯¾å€¤</button>
        <button class="popup-mode-btn" id="mode-pct" onclick="switchPopupMode('pct')">%</button>
    </div>
    <div class="popup-controls">
        <button class="popup-btn" onclick="adjustCellValue(-1)">â–½</button>
        <input type="number" class="popup-input" id="popup-delta" value="10" step="1" min="1">
        <button class="popup-btn" onclick="adjustCellValue(1)">â–³</button>
    </div>
</div>

<div id="main-container">
    <div id="explorer">
        <div class="explorer-header">EXPLORER: PROJECT</div>
        <div class="tree-item"><span class="tree-icon">ğŸ“</span> src</div>
        <div class="tree-item active"><span class="tree-icon">ğŸ“Š</span> Main_Fuel_Map.csv</div>
        <div class="tree-item"><span class="tree-icon">ğŸ“Š</span> Ignition_Map.csv</div>
        <div class="tree-item"><span class="tree-icon">ğŸ“Š</span> Idling_Correction.csv</div>
        <div class="tree-item"><span class="tree-icon">âš™ï¸</span> Settings.json</div>
        
        <div class="explorer-header" style="margin-top:20px;">ACTIONS</div>
        <div style="padding: 0 10px;">
            <p style="font-size: 10px; color: #666; margin: 10px 0;">ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã¯ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„</p>
        </div>
    </div>

    <div id="content-area">
        <div id="map-section">
            <div id="table-wrapper">
                <div id="headerRow" class="header-row"></div>
                <div id="mapGrid" class="grid-container"></div>
            </div>
        </div>

        <div id="info-section">
            <h3>ğŸ“‹ Information</h3>
            <div id="info-content">
                <p style="margin: 5px 0;"><strong>Selected Cell:</strong> <span id="info-cell">-</span></p>
                <p style="margin: 5px 0;"><strong>Current Value:</strong> <span id="info-value">-</span> Î¼s</p>
                <p style="margin: 5px 0;"><strong>Original Value:</strong> <span id="info-original">-</span> Î¼s</p>
                <p style="margin: 5px 0;"><strong>Change:</strong> <span id="info-change">-</span> (<span id="info-change-percent">-</span>)</p>
                <p style="margin: 5px 0;"><strong>Map Range:</strong> <span id="info-range">-</span></p>
            </div>
        </div>
    </div>
</div>

<script>
    const RPM_AXIS = Array.from({length: 20}, (_, i) => 500 + i * 500);
    const TPS_AXIS = Array.from({length: 21}, (_, i) => i * 5);
    let fuelMap = [];
    let originalFuelMap = [];
    let selT = 0, selR = 0;
    let cellColorMode = 'diff';
    
    // è¤‡æ•°ã‚»ãƒ«é¸æŠ
    let selectedCells = new Set(); // "t-r"å½¢å¼ã§ä¿å­˜
    let selectionStart = null; // {t, r}
    let isSelecting = false;
    let isShiftSelecting = false; // Shift+çŸ¢å°ã‚­ãƒ¼ã§ã®ç¯„å›²é¸æŠ
    
    // å±¥æ­´ç®¡ç†
    let history = [];
    let historyIndex = -1;
    const MAX_HISTORY = 50;
    
    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰
    let popupMode = 'abs'; // 'abs' or 'pct'
    let popupDeltaAbs = 10; // çµ¶å¯¾å€¤ãƒ¢ãƒ¼ãƒ‰ã®å€¤ã‚’ä¿å­˜
    let popupDeltaPct = 1.0; // %ãƒ¢ãƒ¼ãƒ‰ã®å€¤ã‚’ä¿å­˜
    
    // ECUæ¥ç¶šçŠ¶æ…‹
    let ecuConnected = false;

    window.openFile = function() {
        console.log('openFile called');
        const fileInput = document.getElementById('file-input');
        if (fileInput) {
            fileInput.click();
        } else {
            console.error('file-input not found');
        }
    };
    
    window.openBaseFile = function() {
        console.log('openBaseFile called');
        const baseFileInput = document.getElementById('base-file-input');
        if (baseFileInput) {
            baseFileInput.click();
        } else {
            console.error('base-file-input not found');
        }
    };

    window.saveFile = function() {
        const now = new Date();
        const dateStr = now.getFullYear() + 
                       String(now.getMonth() + 1).padStart(2, '0') + 
                       String(now.getDate()).padStart(2, '0') + '_' +
                       String(now.getHours()).padStart(2, '0') + 
                       String(now.getMinutes()).padStart(2, '0');
        const defaultName = `fuel_map_${dateStr}.csv`;
        
        const fileName = prompt('ä¿å­˜ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', defaultName);
        
        if (fileName === null || fileName.trim() === '') {
            return;
        }
        
        let csv = "TPS\\RPM," + RPM_AXIS.join(",") + "\n";
        fuelMap.forEach((row, i) => { 
            csv += TPS_AXIS[i] + "," + row.join(",") + "\n"; 
        });
        
        const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        
        const finalName = fileName.trim().endsWith('.csv') ? fileName.trim() : fileName.trim() + '.csv';
        link.download = finalName;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => URL.revokeObjectURL(url), 100);
    };

    window.toggleSettings = function() {
        const menu = document.getElementById('settings-menu');
        const btn = document.getElementById('btn-settings');
        menu.classList.toggle('active');
        btn.classList.toggle('active');
    };

    window.updateCellColorMode = function() {
        cellColorMode = document.getElementById('cell-color-mode').value;
        if (originalFuelMap.length === 0) {
            originalFuelMap = fuelMap.map(row => row.slice());
        }
        renderTable();
    };

    window.toggleECUConnection = function() {
        ecuConnected = !ecuConnected;
        const btn = document.getElementById('btn-ecu-connect');
        const writeBtn = document.getElementById('btn-write');
        const readBtn = document.getElementById('btn-read');
        
        if (ecuConnected) {
            btn.classList.remove('ecu-disconnected');
            btn.classList.add('ecu-connected');
            btn.setAttribute('data-tooltip', 'ECUã‹ã‚‰åˆ‡æ–­');
            writeBtn.disabled = false;
            readBtn.disabled = false;
            alert('ECUã«æ¥ç¶šã—ã¾ã—ãŸï¼ˆãƒ‡ãƒ¢ï¼‰');
        } else {
            btn.classList.remove('ecu-connected');
            btn.classList.add('ecu-disconnected');
            btn.setAttribute('data-tooltip', 'ECUã«æ¥ç¶š');
            writeBtn.disabled = true;
            readBtn.disabled = true;
            alert('ECUã‹ã‚‰åˆ‡æ–­ã—ã¾ã—ãŸï¼ˆãƒ‡ãƒ¢ï¼‰');
        }
    };

    window.writeToECU = function() {
        if (!ecuConnected) return;
        alert('ECUã¸ã®æ›¸ãè¾¼ã¿æ©Ÿèƒ½ã¯æœªå®Ÿè£…ã§ã™');
    };

    window.readFromECU = function() {
        if (!ecuConnected) return;
        alert('ECUã‹ã‚‰ã®èª­ã¿å–ã‚Šæ©Ÿèƒ½ã¯æœªå®Ÿè£…ã§ã™');
    };

    window.toggleGraph = function() {
        const overlay = document.getElementById('graph-overlay');
        const btn = document.getElementById('btn-graph');
        overlay.classList.toggle('active');
        btn.classList.toggle('active');
        if (overlay.classList.contains('active')) {
            updateGraph();
            // ã‚°ãƒ©ãƒ•è¡¨ç¤ºæ™‚ã«ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ã‚’åˆæœŸåŒ–
            setTimeout(() => {
                initGraphResizeHandles();
            }, 100);
        }
    };

    window.undo = function() {
        if (historyIndex > 0) {
            historyIndex--;
            fuelMap = JSON.parse(JSON.stringify(history[historyIndex]));
            renderTable();
            if (document.getElementById('graph-overlay').classList.contains('active')) {
                updateGraph();
            }
        }
    };

    window.switchPopupMode = function(mode) {
        // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã®å€¤ã‚’ä¿å­˜
        const deltaInput = document.getElementById('popup-delta');
        const currentValue = parseFloat(deltaInput.value);
        
        if (popupMode === 'abs') {
            popupDeltaAbs = isNaN(currentValue) ? 10 : Math.round(currentValue);
        } else {
            popupDeltaPct = isNaN(currentValue) ? 1.0 : currentValue;
        }
        
        // ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆ
        popupMode = mode;
        document.getElementById('mode-abs').classList.toggle('active', mode === 'abs');
        document.getElementById('mode-pct').classList.toggle('active', mode === 'pct');
        
        // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å€¤ã‚’å¾©å…ƒ
        if (mode === 'abs') {
            deltaInput.value = Math.round(popupDeltaAbs);
            deltaInput.step = '1';
            deltaInput.min = '1';
        } else {
            deltaInput.value = popupDeltaPct.toFixed(1);
            deltaInput.step = '0.1';
            deltaInput.min = '0.1';
        }
    };

    window.adjustCellValue = function(direction) {
        const deltaInput = document.getElementById('popup-delta');
        let deltaValue = parseFloat(deltaInput.value);
        
        if (isNaN(deltaValue) || deltaValue === 0) return;
        
        // å€¤ã‚’ä¿å­˜ã—ã¦è¡¨ç¤ºã‚’æ›´æ–°
        if (popupMode === 'pct') {
            popupDeltaPct = deltaValue;
            // %ãƒ¢ãƒ¼ãƒ‰ã§ã¯å¸¸ã«å°æ•°ç‚¹1ä½ã¾ã§è¡¨ç¤º
            deltaInput.value = deltaValue.toFixed(1);
        } else {
            popupDeltaAbs = deltaValue;
        }
        
        // é¸æŠã•ã‚Œã¦ã„ã‚‹å…¨ã‚»ãƒ«ã«å¯¾ã—ã¦é©ç”¨
        const cellsToUpdate = selectedCells.size > 0 ? Array.from(selectedCells) : [`${selT}-${selR}`];
        
        cellsToUpdate.forEach(key => {
            const [t, r] = key.split('-').map(Number);
            const currentValue = fuelMap[t][r];
            const originalValue = originalFuelMap[t][r];
            let newValue;
            
            if (popupMode === 'abs') {
                // çµ¶å¯¾å€¤ã§ã®å¢—æ¸›
                newValue = currentValue + (direction * deltaValue);
            } else {
                // å„ã‚»ãƒ«ã®ã‚ªãƒªã‚¸ãƒŠãƒ«å€¤ã®æŒ‡å®š%åˆ†ã‚’ç¾åœ¨å€¤ã«åŠ æ¸›
                const changeAmount = Math.round(originalValue * deltaValue / 100);
                newValue = currentValue + (direction * changeAmount);
            }
            
            fuelMap[t][r] = Math.round(newValue);
            
            // ã‚»ãƒ«ã®è¡¨ç¤ºã‚’æ›´æ–°
            const input = document.querySelector(`#c-${t}-${r} input`);
            if (input) {
                input.value = fuelMap[t][r];
                const cell = document.getElementById(`c-${t}-${r}`);
                cell.style.background = getColor(fuelMap[t][r], t, r);
            }
        });
        
        updateUISelection();
        saveHistory();
        
        if (document.getElementById('graph-overlay').classList.contains('active')) {
            updateGraph();
        }
    };
    
    window.redo = function() {
        if (historyIndex < history.length - 1) {
            historyIndex++;
            fuelMap = JSON.parse(JSON.stringify(history[historyIndex]));
            renderTable();
            if (document.getElementById('graph-overlay').classList.contains('active')) {
                updateGraph();
            }
        }
    };
    
    function saveHistory() {
        // ç¾åœ¨ã®ä½ç½®ã‚ˆã‚Šå¾Œã®å±¥æ­´ã‚’å‰Šé™¤
        history = history.slice(0, historyIndex + 1);
        
        // æ–°ã—ã„çŠ¶æ…‹ã‚’è¿½åŠ 
        history.push(JSON.parse(JSON.stringify(fuelMap)));
        
        // å±¥æ­´ã®ä¸Šé™ã‚’è¶…ãˆãŸã‚‰å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
        if (history.length > MAX_HISTORY) {
            history.shift();
        } else {
            historyIndex++;
        }
    }
    
    function updatePopupPosition() {
        const popup = document.getElementById('cell-popup');
        const selectedCell = document.getElementById(`c-${selT}-${selR}`);
        const mapSection = document.getElementById('map-section');
        
        if (!selectedCell) {
            popup.classList.remove('active');
            return;
        }
        
        const cellRect = selectedCell.getBoundingClientRect();
        const mapRect = mapSection.getBoundingClientRect();
        const popupWidth = 150; // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®å¹…ï¼ˆæ¨å®šï¼‰
        const popupHeight = 80; // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®é«˜ã•ï¼ˆæ¨å®šï¼‰
        
        // å„ç¨®å¢ƒç•Œã®è¨ˆç®—
        const headerRow = document.getElementById('headerRow');
        const headerHeight = headerRow.offsetHeight;
        const visibleTop = mapRect.top + headerHeight;
        const scrollbarHeight = mapSection.offsetHeight - mapSection.clientHeight;
        const visibleBottom = mapRect.bottom - scrollbarHeight;
        const labelWidth = 80;
        const visibleLeft = mapRect.left + labelWidth;
        const visibleRight = mapRect.right;
        
        const infoSection = document.getElementById('info-section');
        const infoRect = infoSection.getBoundingClientRect();
        const infoTop = infoRect.top;
        
        // ã‚»ãƒ«ãŒè¦‹ãˆã¦ã„ãªã„å ´åˆã¯ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’éè¡¨ç¤º
        // ä¸Šç«¯ãƒã‚§ãƒƒã‚¯
        if (cellRect.bottom < visibleTop) {
            popup.classList.remove('active');
            return;
        }
        // ä¸‹ç«¯ãƒã‚§ãƒƒã‚¯ï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼è€ƒæ…®ï¼‰
        if (cellRect.top > visibleBottom) {
            popup.classList.remove('active');
            return;
        }
        // å·¦ç«¯ãƒã‚§ãƒƒã‚¯ï¼ˆTPSåˆ—ãƒ©ãƒ™ãƒ«è€ƒæ…®ï¼‰
        if (cellRect.right < visibleLeft) {
            popup.classList.remove('active');
            return;
        }
        // å³ç«¯ãƒã‚§ãƒƒã‚¯
        if (cellRect.left > visibleRight) {
            popup.classList.remove('active');
            return;
        }
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ï¼šã‚»ãƒ«ã®å³å´
        let left = cellRect.right + 10;
        let top = cellRect.top;
        
        // å³å´ã«è¡¨ç¤ºã‚¹ãƒšãƒ¼ã‚¹ãŒãªã„å ´åˆã¯å·¦å´ã«è¡¨ç¤º
        if (left + popupWidth > visibleRight) {
            // ã‚»ãƒ«ã®å·¦å´ã«é…ç½®ï¼ˆã‚»ãƒ«ã¨é‡ãªã‚‰ãªã„ã‚ˆã†ã«ååˆ†ãªé–“éš”ã‚’å–ã‚‹ï¼‰
            left = cellRect.left - popupWidth - 45;
        }
        
        // å·¦ç«¯ãŒãƒ©ãƒ™ãƒ«åˆ—ã‚ˆã‚Šå·¦ã«ã¯ã¿å‡ºã‚‹å ´åˆ
        if (left < visibleLeft) {
            left = visibleLeft + 5;
        }
        
        // ä¸‹å´ã«è¡¨ç¤ºã‚¹ãƒšãƒ¼ã‚¹ãŒãªã„å ´åˆã¯ä¸Šã«èª¿æ•´
        // INFORMATIONãƒšã‚¤ãƒ³ã¨é‡ãªã‚‰ãªã„ã‚ˆã†ã«
        const maxBottom = Math.min(visibleBottom, infoTop);
        if (top + popupHeight > maxBottom) {
            top = maxBottom - popupHeight - 5;
        }
        
        // ä¸Šå´ãŒãƒ˜ãƒƒãƒ€ãƒ¼ã‚ˆã‚Šä¸Šã«ã¯ã¿å‡ºã‚‹å ´åˆã¯èª¿æ•´
        if (top < visibleTop) {
            top = visibleTop + 5;
        }
        
        popup.style.top = top + 'px';
        popup.style.left = left + 'px';
        popup.classList.add('active');
    }
    
    function saveHistory() {
        // ç¾åœ¨ã®ä½ç½®ã‚ˆã‚Šå¾Œã®å±¥æ­´ã‚’å‰Šé™¤
        history = history.slice(0, historyIndex + 1);
        
        // æ–°ã—ã„çŠ¶æ…‹ã‚’è¿½åŠ 
        history.push(JSON.parse(JSON.stringify(fuelMap)));
        
        // å±¥æ­´ã®ä¸Šé™ã‚’è¶…ãˆãŸã‚‰å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
        if (history.length > MAX_HISTORY) {
            history.shift();
        } else {
            historyIndex++;
        }
    }

    let isDragging = false;
    let initialX, initialY;

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    document.addEventListener('keydown', function(e) {
        // inputè¦ç´ ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹å ´åˆã€ä¸€éƒ¨ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—
        const activeElement = document.activeElement;
        const isInputFocused = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'SELECT');
        
        // Ctrl+O: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
        if (e.ctrlKey && !e.shiftKey && e.key === 'o') {
            e.preventDefault();
            openFile();
        }
        // Ctrl+Shift+O: åŸºæº–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
        else if (e.ctrlKey && e.shiftKey && e.key === 'O') {
            e.preventDefault();
            openBaseFile();
        }
        // Ctrl+S: ä¿å­˜
        else if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            saveFile();
        }
        // Ctrl+Z: å…ƒã«æˆ»ã™ï¼ˆinputä»¥å¤–ï¼‰
        else if (e.ctrlKey && e.key === 'z' && !isInputFocused) {
            e.preventDefault();
            undo();
        }
        // Ctrl+Y: ã‚„ã‚Šç›´ã—ï¼ˆinputä»¥å¤–ï¼‰
        else if (e.ctrlKey && e.key === 'y' && !isInputFocused) {
            e.preventDefault();
            redo();
        }
        // Ctrl+W: ECUã«æ›¸ãè¾¼ã¿
        else if (e.ctrlKey && e.key === 'w') {
            e.preventDefault();
            if (ecuConnected) writeToECU();
        }
        // Ctrl+R: ECUã‹ã‚‰èª­ã¿å–ã‚Š
        else if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            if (ecuConnected) readFromECU();
        }
        // Ctrl+G: ã‚°ãƒ©ãƒ•è¡¨ç¤º
        else if (e.ctrlKey && e.key === 'g') {
            e.preventDefault();
            toggleGraph();
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        const graphHeader = document.getElementById('graph-header');
        const graphOverlay = document.getElementById('graph-overlay');

        graphHeader.addEventListener('mousedown', function(e) {
            if (e.target.id === 'graph-close' || e.target.id === 'graph-type') return;
            isDragging = true;
            initialX = e.clientX - graphOverlay.offsetLeft;
            initialY = e.clientY - graphOverlay.offsetTop;
        });

        document.addEventListener('mousemove', function(e) {
            if (isDragging) {
                e.preventDefault();
                graphOverlay.style.left = (e.clientX - initialX) + 'px';
                graphOverlay.style.top = (e.clientY - initialY) + 'px';
                graphOverlay.style.right = 'auto';
            }
        });

        document.addEventListener('mouseup', function() {
            isDragging = false;
        });

        const resizeObserver = new ResizeObserver(() => {
            if (graphOverlay.classList.contains('active')) {
                setTimeout(() => updateGraph(), 100);
            }
        });
        resizeObserver.observe(graphOverlay);
        
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ä½ç½®ã‚’æ›´æ–°
        const mapSection = document.getElementById('map-section');
        mapSection.addEventListener('scroll', updatePopupPosition);
        
        // ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—ã§é¸æŠçµ‚äº†
        document.addEventListener('mouseup', () => {
            isSelecting = false;
        });
    });

    function initData() {
        for (let t = 0; t < 21; t++) {
            fuelMap[t] = [];
            originalFuelMap[t] = [];
            for (let r = 0; r < 20; r++) {
                const val = Math.floor(1000 + 800 * Math.sin(r/5) * Math.cos(t/10) + t*20);
                fuelMap[t][r] = val;
                originalFuelMap[t][r] = val;
            }
        }
        saveHistory();
    }

    function getColor(val, t, r) {
        if (cellColorMode === 'diff') {
            if (originalFuelMap.length === 0 || !originalFuelMap[t]) {
                return 'rgb(255, 255, 255)';
            }
            const originalVal = originalFuelMap[t][r];
            const diff = val - originalVal;
            
            if (diff === 0) {
                return 'rgb(255, 255, 255)';
            } else if (diff > 0) {
                const intensity = Math.min(Math.abs(diff) / 200, 1);
                const colorValue = Math.floor(255 - 155 * intensity);
                return `rgb(255, ${colorValue}, ${colorValue})`;
            } else {
                const intensity = Math.min(Math.abs(diff) / 200, 1);
                const colorValue = Math.floor(255 - 155 * intensity);
                return `rgb(${colorValue}, ${colorValue}, 255)`;
            }
        } else {
            let min = Infinity, max = -Infinity;
            for (let t = 0; t < 21; t++) {
                for (let r = 0; r < 20; r++) {
                    if (fuelMap[t][r] < min) min = fuelMap[t][r];
                    if (fuelMap[t][r] > max) max = fuelMap[t][r];
                }
            }
            
            let p = (val - min) / (max - min);
            p = Math.max(0, Math.min(1, p));
            
            let red, green, blue;
            if (p < 0.5) {
                const t = p * 2;
                red = 0;
                green = Math.floor(128 * t);
                blue = Math.floor(255 * (1 - t));
            } else {
                const t = (p - 0.5) * 2;
                red = Math.floor(255 * t);
                green = Math.floor(128 * (1 - t));
                blue = 0;
            }
            return `rgb(${red},${green},${blue})`;
        }
    }

    function renderTable() {
        const headerRow = document.getElementById('headerRow');
        const grid = document.getElementById('mapGrid');
        headerRow.innerHTML = '';
        grid.innerHTML = '';
        
        const corner = document.createElement('div');
        corner.className = 'cell header-cell corner-cell';
        corner.innerText = 'TPS\\RPM';
        headerRow.appendChild(corner);

        RPM_AXIS.forEach(r => {
            const h = document.createElement('div');
            h.className = 'cell header-cell';
            h.innerText = r;
            headerRow.appendChild(h);
        });

        TPS_AXIS.forEach((tps, t) => {
            const l = document.createElement('div');
            l.className = 'cell label-cell';
            l.innerText = tps + '%';
            grid.appendChild(l);

            RPM_AXIS.forEach((rpm, r) => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.id = `c-${t}-${r}`;
                
                const input = document.createElement('input');
                input.type = 'number';
                input.value = fuelMap[t][r];
                input.className = cellColorMode === 'diff' ? 'diff-mode' : 'heatmap-mode';
                
                // ã‚»ãƒ«é¸æŠå‡¦ç†
                cell.addEventListener('mousedown', (e) => {
                    e.preventDefault(); // ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã‚’é˜²æ­¢
                    
                    if (e.ctrlKey || e.metaKey) {
                        // Ctrl+ã‚¯ãƒªãƒƒã‚¯: å€‹åˆ¥é¸æŠ/è§£é™¤
                        e.preventDefault();
                        const key = `${t}-${r}`;
                        if (selectedCells.has(key)) {
                            selectedCells.delete(key);
                        } else {
                            selectedCells.add(key);
                        }
                        selT = t; selR = r;
                        updateUISelection();
                    } else if (e.shiftKey) {
                        // Shift+ã‚¯ãƒªãƒƒã‚¯: ç¯„å›²é¸æŠ
                        e.preventDefault();
                        if (selectionStart) {
                            const minT = Math.min(selectionStart.t, t);
                            const maxT = Math.max(selectionStart.t, t);
                            const minR = Math.min(selectionStart.r, r);
                            const maxR = Math.max(selectionStart.r, r);
                            
                            selectedCells.clear();
                            for (let ti = minT; ti <= maxT; ti++) {
                                for (let ri = minR; ri <= maxR; ri++) {
                                    selectedCells.add(`${ti}-${ri}`);
                                }
                            }
                        }
                        selT = t; selR = r;
                        updateUISelection();
                    } else {
                        // é€šå¸¸ã‚¯ãƒªãƒƒã‚¯: å˜ä¸€é¸æŠ
                        selectedCells.clear();
                        selectedCells.add(`${t}-${r}`);
                        selectionStart = {t, r};
                        isSelecting = true;
                    }
                });
                
                // ãƒ‰ãƒ©ãƒƒã‚°é¸æŠ
                cell.addEventListener('mouseenter', (e) => {
                    if (isSelecting && selectionStart) {
                        const minT = Math.min(selectionStart.t, t);
                        const maxT = Math.max(selectionStart.t, t);
                        const minR = Math.min(selectionStart.r, r);
                        const maxR = Math.max(selectionStart.r, r);
                        
                        selectedCells.clear();
                        for (let ti = minT; ti <= maxT; ti++) {
                            for (let ri = minR; ri <= maxR; ri++) {
                                selectedCells.add(`${ti}-${ri}`);
                            }
                        }
                        selT = t; selR = r;
                        updateUISelection();
                    }
                });
                
                input.onfocus = () => {
                    selT = t; selR = r;
                    updateUISelection();
                    input.select();
                    if (document.getElementById('graph-overlay').classList.contains('active')) {
                        updateGraph();
                    }
                };
                
                input.onclick = () => {
                    input.select();
                };
                
                input.oninput = (e) => {
                    fuelMap[t][r] = parseInt(e.target.value) || 0;
                    cell.style.background = getColor(fuelMap[t][r], t, r);
                    updateUISelection();
                    if (document.getElementById('graph-overlay').classList.contains('active')) {
                        updateGraph();
                    }
                };
                
                input.onchange = () => {
                    saveHistory();
                };
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        let nt = t, nr = r;
                        
                        if (e.shiftKey) {
                            // Shift+Enter: ä¸Šã«ç§»å‹•
                            nt--;
                        } else {
                            // Enter: ä¸‹ã«ç§»å‹•
                            nt++;
                        }
                        
                        if (nt >= 0 && nt < 21) {
                            const target = document.querySelector(`#c-${nt}-${nr} input`);
                            target.focus({preventScroll: true});
                            target.select();
                            
                            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‡¦ç†
                            const container = document.getElementById('map-section');
                            const targetCell = document.getElementById(`c-${nt}-${nr}`);
                            
                            requestAnimationFrame(() => {
                                const cellRect = targetCell.getBoundingClientRect();
                                const containerRect = container.getBoundingClientRect();
                                const headerRow = document.getElementById('headerRow');
                                const headerHeight = headerRow.offsetHeight;
                                const scrollbarHeight = container.offsetHeight - container.clientHeight;
                                
                                if (e.shiftKey) {
                                    // ä¸Šç§»å‹•
                                    const visibleTop = containerRect.top + headerHeight;
                                    if (cellRect.top < visibleTop) {
                                        const scrollAmount = visibleTop - cellRect.top;
                                        container.scrollTop -= scrollAmount;
                                    }
                                } else {
                                    // ä¸‹ç§»å‹•
                                    const visibleBottom = containerRect.bottom - scrollbarHeight;
                                    if (cellRect.bottom > visibleBottom) {
                                        const scrollAmount = cellRect.bottom - visibleBottom;
                                        container.scrollTop += scrollAmount;
                                    }
                                }
                            });
                        }
                    }
                    else if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) {
                        e.preventDefault();
                        
                        // Shift+çŸ¢å°ã‚­ãƒ¼ã§ç¯„å›²é¸æŠ
                        if (e.shiftKey) {
                            if (!isShiftSelecting) {
                                isShiftSelecting = true;
                                selectionStart = {t, r};
                                selectedCells.clear();
                                selectedCells.add(`${t}-${r}`);
                            }
                            
                            let nt = selT, nr = selR;
                            
                            if(e.key==="ArrowUp") nt--; 
                            else if(e.key==="ArrowDown") nt++;
                            else if(e.key==="ArrowLeft") nr--;
                            else if(e.key==="ArrowRight") nr++;
                            
                            if(nt>=0 && nt<21 && nr>=0 && nr<20) {
                                selT = nt; selR = nr;
                                
                                // ç¯„å›²é¸æŠã‚’æ›´æ–°
                                const minT = Math.min(selectionStart.t, nt);
                                const maxT = Math.max(selectionStart.t, nt);
                                const minR = Math.min(selectionStart.r, nr);
                                const maxR = Math.max(selectionStart.r, nr);
                                
                                selectedCells.clear();
                                for (let ti = minT; ti <= maxT; ti++) {
                                    for (let ri = minR; ri <= maxR; ri++) {
                                        selectedCells.add(`${ti}-${ri}`);
                                    }
                                }
                                
                                updateUISelection();
                                
                                const target = document.querySelector(`#c-${nt}-${nr} input`);
                                target.focus({preventScroll: true});
                            }
                        } else {
                            // é€šå¸¸ã®çŸ¢å°ã‚­ãƒ¼ç§»å‹•
                            isShiftSelecting = false;
                            selectedCells.clear();
                            selectedCells.add(`${t}-${r}`);
                            
                            let nt = t, nr = r;
                        }
                        if(e.key==="ArrowUp") nt--; 
                        else if(e.key==="ArrowDown") nt++;
                        else if(e.key==="ArrowLeft") nr--;
                        else if(e.key==="ArrowRight") nr++;
                        
                        if(nt>=0 && nt<21 && nr>=0 && nr<20) {
                            const container = document.getElementById('map-section');
                            const target = document.querySelector(`#c-${nt}-${nr} input`);
                            
                            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç§»å‹•ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã—ï¼‰
                            target.focus({preventScroll: true});
                            target.select();
                            
                            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‡¦ç†
                            const targetCell = document.getElementById(`c-${nt}-${nr}`);
                            const headerRow = document.getElementById('headerRow');
                            
                            requestAnimationFrame(() => {
                                const cellRect = targetCell.getBoundingClientRect();
                                const containerRect = container.getBoundingClientRect();
                                const headerHeight = headerRow.offsetHeight;
                                const labelWidth = 80;
                                
                                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®é«˜ã•ã‚’å–å¾—
                                const scrollbarHeight = container.offsetHeight - container.clientHeight;
                                
                                // ä¸ŠçŸ¢å°ï¼šãƒ˜ãƒƒãƒ€ãƒ¼ã®ç›´ä¸‹ã«è¡¨ç¤º
                                if (e.key === "ArrowUp") {
                                    const visibleTop = containerRect.top + headerHeight;
                                    if (cellRect.top < visibleTop) {
                                        const scrollAmount = visibleTop - cellRect.top;
                                        container.scrollTop -= scrollAmount;
                                    }
                                }
                                // ä¸‹çŸ¢å°ï¼šã‚³ãƒ³ãƒ†ãƒŠã®åº•éƒ¨ã«è¡¨ç¤ºï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’è€ƒæ…®ï¼‰
                                else if (e.key === "ArrowDown") {
                                    const visibleBottom = containerRect.bottom - scrollbarHeight;
                                    if (cellRect.bottom > visibleBottom) {
                                        const scrollAmount = cellRect.bottom - visibleBottom;
                                        container.scrollTop += scrollAmount;
                                    }
                                }
                                // å·¦çŸ¢å°ï¼šãƒ©ãƒ™ãƒ«åˆ—ã®å³å´ã«è¡¨ç¤º
                                else if (e.key === "ArrowLeft") {
                                    const visibleLeft = containerRect.left + labelWidth;
                                    if (cellRect.left < visibleLeft) {
                                        const scrollAmount = visibleLeft - cellRect.left;
                                        container.scrollLeft -= scrollAmount;
                                    }
                                }
                                // å³çŸ¢å°ï¼šã‚³ãƒ³ãƒ†ãƒŠã®å³ç«¯ã«è¡¨ç¤º
                                else if (e.key === "ArrowRight") {
                                    const visibleRight = containerRect.right;
                                    if (cellRect.right > visibleRight) {
                                        const scrollAmount = cellRect.right - visibleRight;
                                        container.scrollLeft += scrollAmount;
                                    }
                                }
                            });
                        }
                    }
                });
                
                cell.style.background = getColor(fuelMap[t][r], t, r);
                cell.appendChild(input);
                grid.appendChild(cell);
            });
        });
        updateUISelection();
    }

    function updateUISelection() {
        document.querySelectorAll('.cell').forEach(c => c.classList.remove('selected-cell', 'cross-highlight', 'multi-selected-cell'));
        document.querySelectorAll('.header-cell').forEach(h => h.classList.remove('selected-header'));
        document.querySelectorAll('.label-cell').forEach(l => l.classList.remove('selected-label'));
        
        // è¤‡æ•°é¸æŠã•ã‚ŒãŸã‚»ãƒ«ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        selectedCells.forEach(key => {
            const [ct, cr] = key.split('-').map(Number);
            const cell = document.getElementById(`c-${ct}-${cr}`);
            if (cell) {
                cell.classList.add('multi-selected-cell');
            }
        });
        
        const selectedCell = document.getElementById(`c-${selT}-${selR}`);
        if (selectedCell) {
            selectedCell.classList.add('selected-cell');
            for(let r=0; r<20; r++) {
                const cell = document.getElementById(`c-${selT}-${r}`);
                if (cell) cell.classList.add('cross-highlight');
            }
            for(let t=0; t<21; t++) {
                const cell = document.getElementById(`c-${t}-${selR}`);
                if (cell) cell.classList.add('cross-highlight');
            }
        }
        
        // é¸æŠã•ã‚ŒãŸRPMãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ˜ã‚‹ãã™ã‚‹
        const headerCells = document.getElementById('headerRow').children;
        if (headerCells[selR + 1]) {
            headerCells[selR + 1].classList.add('selected-header');
        }
        
        // é¸æŠã•ã‚ŒãŸTPSãƒ©ãƒ™ãƒ«ã‚’æ˜ã‚‹ãã™ã‚‹
        const gridCells = document.getElementById('mapGrid').children;
        const labelIndex = selT * 21; // å„è¡Œã¯21å€‹ã®ã‚»ãƒ«ï¼ˆ1å€‹ã®ãƒ©ãƒ™ãƒ« + 20å€‹ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ«ï¼‰
        if (gridCells[labelIndex]) {
            gridCells[labelIndex].classList.add('selected-label');
        }
        
        // æƒ…å ±ãƒ‘ãƒãƒ«ã®æ›´æ–°
        const currentValue = fuelMap[selT][selR];
        const originalValue = originalFuelMap[selT][selR];
        const change = currentValue - originalValue;
        const changePercent = originalValue !== 0 ? ((change / originalValue) * 100).toFixed(1) : '0.0';
        
        const cellCount = selectedCells.size;
        if (cellCount > 1) {
            document.getElementById('info-cell').innerText = `${cellCount} cells selected (Main: RPM ${RPM_AXIS[selR]}, TPS ${TPS_AXIS[selT]}%)`;
        } else {
            document.getElementById('info-cell').innerText = `RPM: ${RPM_AXIS[selR]}, TPS: ${TPS_AXIS[selT]}%`;
        }
        
        document.getElementById('info-value').innerText = currentValue;
        document.getElementById('info-original').innerText = originalValue;
        
        const changeSign = change >= 0 ? '+' : '';
        document.getElementById('info-change').innerText = `${changeSign}${change} Î¼s`;
        document.getElementById('info-change-percent').innerText = `${changeSign}${changePercent}%`;
        
        let min = Infinity, max = -Infinity;
        for (let t = 0; t < 21; t++) {
            for (let r = 0; r < 20; r++) {
                if (fuelMap[t][r] < min) min = fuelMap[t][r];
                if (fuelMap[t][r] > max) max = fuelMap[t][r];
            }
        }
        document.getElementById('info-range').innerText = `${min} - ${max} Î¼s`;
        
        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ä½ç½®æ›´æ–°
        updatePopupPosition();
    }

    function updateGraph() {
        const overlay = document.getElementById('graph-overlay');
        if (!overlay.classList.contains('active')) return;
        
        const mode = document.getElementById('graph-type').value;
        let traces = [];
        const layout = {
            paper_bgcolor: '#1e1e1e', plot_bgcolor: '#1e1e1e',
            margin: {t:20, l:50, r:20, b:50},
            font: {color: '#888', size: 10},
            xaxis: {gridcolor: '#333', zeroline: false}, 
            yaxis: {gridcolor: '#333', zeroline: false}
        };

        if (mode === '3d') {
            traces = [{
                z: fuelMap, x: RPM_AXIS, y: TPS_AXIS, type: 'surface',
                colorscale: [[0, 'blue'], [0.5, 'green'], [1, 'red']], showscale: false
            }];
            layout.scene = { 
                xaxis: {title:'RPM'}, 
                yaxis: {title:'TPS'}, 
                zaxis: {title:'Fuel'},
                camera: {eye: {x: 1.3, y: 1.3, z: 1.5}}
            };
            layout.margin = {t:5, l:5, r:5, b:15};
        } else if (mode === 'tps') {
            traces = [{
                x: TPS_AXIS, y: fuelMap.map(row => row[selR]),
                type: 'scatter', mode: 'lines+markers', 
                line: {color: '#0078d4', shape: 'linear'}
            }];
            layout.xaxis.title = "TPS (%)"; 
            layout.yaxis.title = "Fuel (Î¼s)";
        } else {
            traces = [{
                x: RPM_AXIS, y: fuelMap[selT],
                type: 'scatter', mode: 'lines+markers', 
                line: {color: '#0078d4', shape: 'linear'}
            }];
            layout.xaxis.title = "RPM"; 
            layout.yaxis.title = "Fuel (Î¼s)";
        }

        Plotly.newPlot('chart-container', traces, layout, {responsive: true, displayModeBar: false});
    }

    function importFromCSV(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split('\n').filter(l => l.trim());
            lines.shift();
            lines.forEach((line, t) => {
                const values = line.split(',');
                values.shift();
                if (t < 21) {
                    values.forEach((val, r) => {
                        if (r < 20) fuelMap[t][r] = parseInt(val) || 0;
                    });
                }
            });
            originalFuelMap = fuelMap.map(row => row.slice());
            saveHistory();
            renderTable();
            if (document.getElementById('graph-overlay').classList.contains('active')) {
                updateGraph();
            }
        };
        reader.readAsText(file);
    }
    
    function importBaseFromCSV(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split('\n').filter(l => l.trim());
            lines.shift();
            lines.forEach((line, t) => {
                const values = line.split(',');
                values.shift();
                if (t < 21) {
                    values.forEach((val, r) => {
                        if (r < 20) originalFuelMap[t][r] = parseInt(val) || 0;
                    });
                }
            });
            renderTable();
            updateUISelection();
        };
        reader.readAsText(file);
    }

    window.onload = () => { 
        initData(); 
        renderTable();
    };
    
    let graphResizeInitialized = false;
    
    function initGraphResizeHandles() {
        if (graphResizeInitialized) return;
        
        const graphOverlay = document.getElementById('graph-overlay');
        
        // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«
        const handles = ['n', 's', 'e', 'w', 'ne', 'nw', 'se', 'sw'];
        handles.forEach(dir => {
            const handle = graphOverlay.querySelector(`.resize-${dir}`);
            if (handle) {
                handle.onmousedown = function(e) {
                    e.preventDefault();
                    
                    isResizing = true;
                    resizeDirection = dir;
                    resizeStartX = e.clientX;
                    resizeStartY = e.clientY;
                    const overlay = document.getElementById('graph-overlay');
                    resizeStartWidth = overlay.offsetWidth;
                    resizeStartHeight = overlay.offsetHeight;
                    resizeStartLeft = overlay.offsetLeft;
                    resizeStartTop = overlay.offsetTop;
                    
                    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå…¨ä½“ã§mousemoveã¨mouseupã‚’ç›£è¦–
                    const onMouseMove = function(e) {
                        if (!isResizing) return;
                        e.preventDefault();
                        
                        const deltaX = e.clientX - resizeStartX;
                        const deltaY = e.clientY - resizeStartY;
                        const overlay = document.getElementById('graph-overlay');
                        
                        let newWidth = resizeStartWidth;
                        let newHeight = resizeStartHeight;
                        let newLeft = resizeStartLeft;
                        let newTop = resizeStartTop;
                        
                        if (resizeDirection.includes('e')) {
                            newWidth = Math.max(300, resizeStartWidth + deltaX);
                        }
                        if (resizeDirection.includes('w')) {
                            const potentialWidth = resizeStartWidth - deltaX;
                            if (potentialWidth >= 300) {
                                newWidth = potentialWidth;
                                newLeft = resizeStartLeft + deltaX;
                            }
                        }
                        if (resizeDirection.includes('s')) {
                            newHeight = Math.max(200, resizeStartHeight + deltaY);
                        }
                        if (resizeDirection.includes('n')) {
                            const potentialHeight = resizeStartHeight - deltaY;
                            if (potentialHeight >= 200) {
                                newHeight = potentialHeight;
                                newTop = resizeStartTop + deltaY;
                            }
                        }
                        
                        overlay.style.width = newWidth + 'px';
                        overlay.style.height = newHeight + 'px';
                        overlay.style.left = newLeft + 'px';
                        overlay.style.top = newTop + 'px';
                        overlay.style.right = 'auto';
                        overlay.style.bottom = 'auto';
                        
                        updateGraph();
                    };
                    
                    const onMouseUp = function(e) {
                        isResizing = false;
                        resizeDirection = '';
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    };
                    
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                };
            }
        });
        
        graphResizeInitialized = true;
    }
</script>
</body>
</html>