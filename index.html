<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ECU Map Studio 2026</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        :root { --accent: #0078d4; --bg: #1e1e1e; --panel: #252526; --border: #3c3c3c; --text: #cccccc; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* „ÉÑ„Éº„É´„Éê„Éº */
        #toolbar { background: #2d2d30; padding: 0; border-bottom: 1px solid var(--border); display: flex; align-items: center; height: 40px; }
        .toolbar-btn { 
            background: transparent; 
            border: none; 
            color: var(--text); 
            padding: 8px 16px; 
            cursor: pointer; 
            font-size: 18px;
            height: 100%;
            border-right: 1px solid var(--border);
            transition: background 0.2s;
            position: relative;
        }
        .toolbar-btn:hover { background: #3e3e42; }
        .toolbar-btn:active { background: #007acc; }
        .toolbar-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 100%;
            left: 0;
            background: #1e1e1e;
            color: #fff;
            padding: 6px 10px;
            border-radius: 3px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            border: 1px solid var(--border);
            z-index: 10000;
            margin-top: 5px;
        }
        .toolbar-btn:hover::after {
            opacity: 1;
        }
        .toolbar-title { padding: 0 16px; font-size: 12px; color: #888; margin-left: auto; }
        
        /* „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº */
        .hamburger-menu { 
            background: transparent; 
            border: none; 
            color: var(--text); 
            padding: 8px 16px; 
            cursor: pointer; 
            font-size: 20px;
            height: 100%;
            border-left: 1px solid var(--border);
            transition: background 0.2s;
        }
        .hamburger-menu:hover { background: #3e3e42; }
        
        /* Ë®≠ÂÆö„É°„Éã„É•„Éº */
        #settings-menu {
            position: fixed;
            top: 40px;
            right: 0;
            width: 300px;
            background: var(--panel);
            border: 1px solid var(--border);
            box-shadow: 0 4px 16px rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            padding: 15px;
        }
        #settings-menu.active { display: block; }
        #settings-menu h3 { margin: 0 0 15px 0; font-size: 14px; color: var(--accent); }
        .setting-item { margin-bottom: 15px; }
        .setting-item label { display: block; font-size: 12px; color: var(--text); margin-bottom: 5px; }
        .setting-item select {
            width: 100%;
            background: #3c3c3c;
            color: var(--text);
            border: 1px solid var(--border);
            padding: 5px;
            font-size: 12px;
        }

        #main-container { display: flex; flex: 1; overflow: hidden; }
        #explorer { width: 220px; background: var(--panel); border-right: 1px solid var(--border); font-size: 13px; flex-shrink: 0; }
        .explorer-header { padding: 10px; font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase; }
        .tree-item { padding: 4px 20px; cursor: pointer; display: flex; align-items: center; white-space: nowrap; }
        .tree-item:hover { background: #2a2d2e; }
        .tree-item.active { background: #37373d; color: #fff; border-left: 2px solid var(--accent); }
        .tree-icon { margin-right: 8px; font-size: 14px; }
        #content-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        #map-section { flex: 1; overflow: auto; background: #000; position: relative; }
        
        #info-section { height: 120px; background: var(--panel); border-top: 1px solid var(--border); padding: 15px; font-size: 12px; overflow-y: auto; }
        #info-section h3 { margin: 0 0 10px 0; font-size: 11px; color: #888; text-transform: uppercase; }
        #info-content { color: var(--text); }
        
        /* „Ç∞„É©„Éï„Ç™„Éº„Éê„Éº„É¨„Ç§Ôºà„É™„Çµ„Ç§„Ç∫ÂèØËÉΩÔºâ */
        #graph-overlay { 
            position: fixed; 
            top: 69px;
            right: 20px; 
            width: 400px; 
            height: 300px; 
            background: var(--panel); 
            border: 1px solid var(--border); 
            box-shadow: 0 8px 32px rgba(0,0,0,0.5); 
            z-index: 1000;
            display: none;
            flex-direction: column;
            resize: both;
            overflow: auto;
            min-width: 300px;
            min-height: 200px;
        }
        #graph-overlay.active { display: flex; }
        #graph-header { 
            background: #2d2d30; 
            padding: 8px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 1px solid var(--border);
            cursor: move;
        }
        #graph-close { 
            background: transparent; 
            border: none; 
            color: var(--text); 
            font-size: 20px; 
            cursor: pointer; 
            padding: 0 8px;
            line-height: 1;
        }
        #graph-close:hover { color: #fff; background: #e81123; }
        #graph-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 10px; }
        #chart-container { flex: 1; min-height: 0; }
        #chart-controls { 
            padding: 10px 0 0 0; 
            display: flex; 
            align-items: center; 
            gap: 10px;
        }
        #chart-controls label { font-size: 12px; color: var(--text); }
        #chart-controls select { 
            background: #3c3c3c; 
            color: var(--text); 
            border: 1px solid var(--border); 
            padding: 5px 10px; 
            font-size: 12px;
            cursor: pointer;
        }
        #chart-controls select:focus { outline: 2px solid var(--accent); }
        
        #table-wrapper { position: relative; min-height: 100%; }
        
        .header-row { 
            position: sticky; 
            top: 0; 
            z-index: 150; 
            display: grid; 
            grid-template-columns: 80px repeat(20, 60px); 
            gap: 1px; 
            background: var(--border);
            width: max-content;
        }
        
        .grid-container { display: grid; grid-template-columns: 80px repeat(20, 60px); gap: 1px; background: var(--border); width: max-content; isolation: isolate; }
        
        .cell { height: 28px; display: flex; align-items: center; justify-content: center; position: relative; background: #1a1a1a; box-sizing: border-box; }
        .header-cell { background: #2d2d2d !important; color: #fff; font-size: 10px; height: 28px; box-sizing: border-box; }
        .label-cell { 
            background: #2d2d2d !important; 
            font-size: 10px; 
            position: sticky; 
            left: 0; 
            z-index: 200;
            border-right: 2px solid var(--border); 
            border-bottom: 1px solid var(--border);
            width: 80px;
            height: 28px;
            box-sizing: border-box;
        }
        .corner-cell { z-index: 250; position: sticky; left: 0; width: 80px; }
        
        .cell input { width: 100%; height: 100%; border: none; text-align: center; background: transparent; font-size: 12px; outline: none; position: relative; z-index: 1; }
        .cell input.diff-mode { color: #000; }
        .cell input.heatmap-mode { color: #fff; }
        .selected-cell { outline: 2px solid var(--accent) !important; z-index: 60; position: relative; }
        .selected-cell::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid var(--accent);
            pointer-events: none;
            z-index: 1;
        }
        .cross-highlight::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; border: 1px solid rgba(255,255,255,0.1); pointer-events: none; z-index: 1; }

        .btn { background: #333; color: #fff; border: 1px solid #555; padding: 4px 10px; cursor: pointer; font-size: 11px; margin-top: 5px; width: 100%; }
        .btn:hover { background: #444; }
    </style>
</head>
<body>

<div id="toolbar">
    <button class="toolbar-btn" data-tooltip="„Éï„Ç°„Ç§„É´„ÇíÈñã„Åè" onclick="openFile()">üìÅ</button>
    <button class="toolbar-btn" data-tooltip="‰øùÂ≠ò" onclick="saveFile()">üíæ</button>
    <button class="toolbar-btn" data-tooltip="ECU„Å´Êõ∏„ÅçËæº„Åø" onclick="writeToECU()">üì§</button>
    <button class="toolbar-btn" data-tooltip="ECU„Åã„ÇâË™≠„ÅøÂèñ„Çä" onclick="readFromECU()">üì•</button>
    <button class="toolbar-btn" data-tooltip="„Ç∞„É©„ÉïË°®Á§∫" onclick="toggleGraph()">üìä</button>
    <span class="toolbar-title">ECU Map Studio - Kitaco S3 v1.0</span>
    <button class="hamburger-menu" onclick="toggleSettings()">‚ò∞</button>
</div>

<!-- Ë®≠ÂÆö„É°„Éã„É•„Éº -->
<div id="settings-menu">
    <h3>‚öôÔ∏è Ë®≠ÂÆö</h3>
    <div class="setting-item">
        <label>„Çª„É´Êï∞ÂÄ§„ÅÆËâ≤Ë°®Á§∫:</label>
        <select id="cell-color-mode" onchange="updateCellColorMode()">
            <option value="heatmap">„Éí„Éº„Éà„Éû„ÉÉ„ÉóÔºàÈùí‚ÜíÁ∑ë‚ÜíËµ§Ôºâ</option>
            <option value="diff">Â∑ÆÂàÜË°®Á§∫ÔºàÁ∑®ÈõÜ: Ëµ§/ÈùíÔºâ</option>
        </select>
    </div>
</div>

<div id="graph-overlay">
    <div id="graph-header">
        <select id="graph-type" onchange="updateGraph()">
            <option value="rpm">2D: vs RPM (Fix TPS)</option>
            <option value="tps">2D: vs TPS (Fix RPM)</option>
            <option value="3d">3D: Surface</option>
        </select>
        <button id="graph-close" onclick="toggleGraph()">√ó</button>
    </div>
    <div id="graph-body">
        <div id="chart-container"></div>
    </div>
</div>

<input type="file" id="file-input" style="display:none" onchange="importFromCSV(this)">
<input type="file" id="save-file-input" style="display:none" nwsaveas="fuel_map.csv">

<div id="main-container">
    <div id="explorer">
        <div class="explorer-header">EXPLORER: PROJECT</div>
        <div class="tree-item"><span class="tree-icon">üìÅ</span> src</div>
        <div class="tree-item active"><span class="tree-icon">üìä</span> Main_Fuel_Map.csv</div>
        <div class="tree-item"><span class="tree-icon">üìä</span> Ignition_Map.csv</div>
        <div class="tree-item"><span class="tree-icon">üìä</span> Idling_Correction.csv</div>
        <div class="tree-item"><span class="tree-icon">‚öôÔ∏è</span> Settings.json</div>
        
        <div class="explorer-header" style="margin-top:20px;">ACTIONS</div>
        <div style="padding: 0 10px;">
            <p style="font-size: 10px; color: #666; margin: 10px 0;">„Éï„Ç°„Ç§„É´Êìç‰Ωú„ÅØ„ÉÑ„Éº„É´„Éê„Éº„Åã„ÇâÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
        </div>
    </div>

    <div id="content-area">
        <div id="map-section">
            <div id="table-wrapper">
                <div id="headerRow" class="header-row"></div>
                <div id="mapGrid" class="grid-container"></div>
            </div>
        </div>

        <div id="info-section">
            <h3>üìã Information</h3>
            <div id="info-content">
                <p style="margin: 5px 0;"><strong>Selected Cell:</strong> <span id="info-cell">-</span></p>
                <p style="margin: 5px 0;"><strong>Value:</strong> <span id="info-value">-</span> Œºs</p>
                <p style="margin: 5px 0;"><strong>Map Range:</strong> <span id="info-range">-</span></p>
            </div>
        </div>
    </div>
</div>

<script>
    const RPM_AXIS = Array.from({length: 20}, (_, i) => 500 + i * 500);
    const TPS_AXIS = Array.from({length: 21}, (_, i) => i * 5);
    let fuelMap = [];
    let originalFuelMap = []; // „Ç™„É™„Ç∏„Éä„É´„Éá„Éº„Çø‰øùÂ≠òÁî®
    let selT = 0, selR = 0;
    let cellColorMode = 'heatmap'; // 'heatmap' or 'diff'

    // „ÉÑ„Éº„É´„Éê„ÉºÈñ¢Êï∞
    window.openFile = function() {
        document.getElementById('file-input').click();
    };

    window.saveFile = function() {
        // ÁèæÂú®„ÅÆÊó•ÊôÇ„Åß„Éá„Éï„Ç©„É´„Éà„Éï„Ç°„Ç§„É´Âêç„ÇíÁîüÊàê
        const now = new Date();
        const dateStr = now.getFullYear() + 
                       String(now.getMonth() + 1).padStart(2, '0') + 
                       String(now.getDate()).padStart(2, '0') + '_' +
                       String(now.getHours()).padStart(2, '0') + 
                       String(now.getMinutes()).padStart(2, '0');
        const defaultName = `fuel_map_${dateStr}.csv`;
        
        // „Éï„Ç°„Ç§„É´ÂêçÂÖ•Âäõ„ÉÄ„Ç§„Ç¢„É≠„Ç∞
        const fileName = prompt('‰øùÂ≠ò„Åô„Çã„Éï„Ç°„Ç§„É´Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', defaultName);
        
        if (fileName === null || fileName.trim() === '') {
            return; // „Ç≠„É£„É≥„Çª„É´„Åæ„Åü„ÅØÁ©∫ÁôΩ„ÅÆÂ†¥Âêà„ÅØ‰øùÂ≠ò„Åó„Å™„ÅÑ
        }
        
        // CSV„Éá„Éº„Çø„Çí‰ΩúÊàê
        let csv = "TPS\\RPM," + RPM_AXIS.join(",") + "\n";
        fuelMap.forEach((row, i) => { 
            csv += TPS_AXIS[i] + "," + row.join(",") + "\n"; 
        });
        
        // Blob„Çí‰ΩúÊàê„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        
        // .csvÊã°ÂºµÂ≠ê„Åå„Å™„ÅÑÂ†¥Âêà„ÅØËøΩÂä†
        const finalName = fileName.trim().endsWith('.csv') ? fileName.trim() : fileName.trim() + '.csv';
        link.download = finalName;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        setTimeout(() => {
            URL.revokeObjectURL(url);
        }, 100);
    };

    window.toggleSettings = function() {
        const menu = document.getElementById('settings-menu');
        menu.classList.toggle('active');
    };

    window.updateCellColorMode = function() {
        cellColorMode = document.getElementById('cell-color-mode').value;
        
        // „Ç™„É™„Ç∏„Éä„É´„Éá„Éº„Çø„Çí‰øùÂ≠òÔºàÂàùÂõû„ÅÆ„ÅøÔºâ
        if (originalFuelMap.length === 0) {
            originalFuelMap = fuelMap.map(row => row.slice());
        }
        
        renderTable();
    };

    window.writeToECU = function() {
        alert('ECU„Å∏„ÅÆÊõ∏„ÅçËæº„ÅøÊ©üËÉΩ„ÅØÊú™ÂÆüË£Ö„Åß„Åô');
    };

    window.readFromECU = function() {
        alert('ECU„Åã„Çâ„ÅÆË™≠„ÅøÂèñ„ÇäÊ©üËÉΩ„ÅØÊú™ÂÆüË£Ö„Åß„Åô');
    };

    window.toggleGraph = function() {
        const overlay = document.getElementById('graph-overlay');
        overlay.classList.toggle('active');
        if (overlay.classList.contains('active')) {
            updateGraph();
        }
    };

    // „Ç∞„É©„Éï„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅÆ„Éâ„É©„ÉÉ„Ç∞Ê©üËÉΩ„Å®„É™„Çµ„Ç§„Ç∫Áõ£Ë¶ñ
    let isDragging = false;
    let currentX, currentY, initialX, initialY;
    let resizeObserver;

    document.addEventListener('DOMContentLoaded', function() {
        const graphHeader = document.getElementById('graph-header');
        const graphOverlay = document.getElementById('graph-overlay');

        graphHeader.addEventListener('mousedown', function(e) {
            if (e.target.id === 'graph-close' || e.target.id === 'graph-type') return;
            isDragging = true;
            initialX = e.clientX - graphOverlay.offsetLeft;
            initialY = e.clientY - graphOverlay.offsetTop;
        });

        document.addEventListener('mousemove', function(e) {
            if (isDragging) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                graphOverlay.style.left = currentX + 'px';
                graphOverlay.style.top = currentY + 'px';
                graphOverlay.style.right = 'auto';
            }
        });

        document.addEventListener('mouseup', function() {
            isDragging = false;
        });

        // „É™„Çµ„Ç§„Ç∫Áõ£Ë¶ñ
        resizeObserver = new ResizeObserver(entries => {
            for (let entry of entries) {
                if (entry.target === graphOverlay && graphOverlay.classList.contains('active')) {
                    // „É™„Çµ„Ç§„Ç∫Âæå„Å´„Ç∞„É©„Éï„ÇíÂÜçÊèèÁîª
                    setTimeout(() => {
                        updateGraph();
                    }, 100);
                }
            }
        });
        
        resizeObserver.observe(graphOverlay);
    });

    function initData() {
        for (let t = 0; t < 21; t++) {
            fuelMap[t] = [];
            originalFuelMap[t] = [];
            for (let r = 0; r < 20; r++) {
                const val = Math.floor(1000 + 800 * Math.sin(r/5) * Math.cos(t/10) + t*20);
                fuelMap[t][r] = val;
                originalFuelMap[t][r] = val;
            }
        }
    }

    function getColor(val, t, r) {
        if (cellColorMode === 'diff') {
            // Â∑ÆÂàÜË°®Á§∫„É¢„Éº„Éâ
            if (originalFuelMap.length === 0 || !originalFuelMap[t]) {
                return 'rgb(255, 255, 255)'; // ÂàùÊúüÂÄ§: ÁôΩ
            }
            const originalVal = originalFuelMap[t][r];
            const diff = val - originalVal;
            
            if (diff === 0) {
                return 'rgb(255, 255, 255)'; // Â§âÊõ¥„Å™„Åó: ÁôΩ
            } else if (diff > 0) {
                // „Éó„É©„Çπ: Ëµ§ÔºàÂ∑Æ„ÅåÂ§ß„Åç„ÅÑ„Åª„Å©ÊøÉ„ÅÑÔºâ
                const intensity = Math.min(Math.abs(diff) / 200, 1);
                const colorValue = Math.floor(255 - 155 * intensity);
                return `rgb(255, ${colorValue}, ${colorValue})`;
            } else {
                // „Éû„Ç§„Éä„Çπ: ÈùíÔºàÂ∑Æ„ÅåÂ§ß„Åç„ÅÑ„Åª„Å©ÊøÉ„ÅÑÔºâ
                const intensity = Math.min(Math.abs(diff) / 200, 1);
                const colorValue = Math.floor(255 - 155 * intensity);
                return `rgb(${colorValue}, ${colorValue}, 255)`;
            }
        } else {
            // „Éí„Éº„Éà„Éû„ÉÉ„Éó„É¢„Éº„Éâ
            let min = Infinity, max = -Infinity;
            for (let t = 0; t < 21; t++) {
                for (let r = 0; r < 20; r++) {
                    if (fuelMap[t][r] < min) min = fuelMap[t][r];
                    if (fuelMap[t][r] > max) max = fuelMap[t][r];
                }
            }
            
            let p = (val - min) / (max - min);
            p = Math.max(0, Math.min(1, p));
            
            let red, green, blue;
            if (p < 0.5) {
                const t = p * 2;
                red = 0;
                green = Math.floor(128 * t);
                blue = Math.floor(255 * (1 - t));
            } else {
                const t = (p - 0.5) * 2;
                red = Math.floor(255 * t);
                green = Math.floor(128 * (1 - t));
                blue = 0;
            }
            return `rgb(${red},${green},${blue})`;
        }
    }

    function renderTable() {
        const headerRow = document.getElementById('headerRow');
        const grid = document.getElementById('mapGrid');
        headerRow.innerHTML = '';
        grid.innerHTML = '';
        
        const corner = document.createElement('div');
        corner.className = 'cell header-cell corner-cell';
        corner.innerText = 'TPS\\RPM';
        headerRow.appendChild(corner);

        RPM_AXIS.forEach(r => {
            const h = document.createElement('div');
            h.className = 'cell header-cell';
            h.innerText = r;
            headerRow.appendChild(h);
        });

        TPS_AXIS.forEach((tps, t) => {
            const l = document.createElement('div');
            l.className = 'cell label-cell';
            l.innerText = tps + '%';
            grid.appendChild(l);

            RPM_AXIS.forEach((rpm, r) => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.id = `c-${t}-${r}`;
                
                const input = document.createElement('input');
                input.type = 'number';
                input.value = fuelMap[t][r];
                input.className = cellColorMode === 'diff' ? 'diff-mode' : 'heatmap-mode';
                
                input.onfocus = () => {
                    selT = t; selR = r;
                    updateUISelection();
                    if (document.getElementById('graph-overlay').classList.contains('active')) {
                        updateGraph();
                    }
                };
                
                input.oninput = (e) => {
                    fuelMap[t][r] = parseInt(e.target.value) || 0;
                    cell.style.background = getColor(fuelMap[t][r]);
                    if (document.getElementById('graph-overlay').classList.contains('active')) {
                        updateGraph();
                    }
                };
                
                input.addEventListener('keydown', (e) => {
                    if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) {
                        e.preventDefault();
                        let nt = t, nr = r;
                        
                        if(e.key==="ArrowUp") nt--; 
                        else if(e.key==="ArrowDown") nt++;
                        else if(e.key==="ArrowLeft") nr--;
                        else if(e.key==="ArrowRight") nr++;
                        
                        if(nt>=0 && nt<21 && nr>=0 && nr<20) {
                            const container = document.getElementById('map-section');
                            const gridContainer = document.getElementById('mapGrid');
                            const targetCellElement = document.getElementById(`c-${nt}-${nr}`);
                            const colWidth = 61;
                            const labelWidth = 80;
                            
                            const target = document.querySelector(`#c-${nt}-${nr} input`);
                            target.focus({preventScroll: true});
                            target.select();
                            
                            requestAnimationFrame(() => {
                                const rect = targetCellElement.getBoundingClientRect();
                                const containerRect = container.getBoundingClientRect();
                                const headerRow = document.getElementById('headerRow');
                                const headerHeight = headerRow.offsetHeight;
                                const targetTop = containerRect.top + headerHeight;
                                
                                if (e.key === "ArrowUp") {
                                    const offset = rect.top - targetTop;
                                    if (Math.abs(offset) > 1) {
                                        container.scrollTop = container.scrollTop + offset;
                                    }
                                }
                                else if (e.key === "ArrowDown") {
                                    const actualBottom = containerRect.top + container.clientHeight;
                                    
                                    if (rect.bottom > actualBottom - 1) {
                                        const overflow = rect.bottom - actualBottom;
                                        container.scrollTop = container.scrollTop + overflow + 2;
                                    }
                                }
                                else if (e.key === "ArrowLeft") {
                                    if (rect.left < containerRect.left + labelWidth) {
                                        const targetScrollLeft = (nr) * colWidth;
                                        container.scrollLeft = targetScrollLeft;
                                    }
                                }
                                else if (e.key === "ArrowRight") {
                                    if (rect.right > containerRect.right) {
                                        const overflow = rect.right - containerRect.right;
                                        container.scrollLeft = container.scrollLeft + overflow;
                                    }
                                }
                            });
                        }
                    }
                });
                
                cell.style.background = getColor(fuelMap[t][r]);
                cell.appendChild(input);
                grid.appendChild(cell);
            });
        });
        updateUISelection();
    }

    function updateUISelection() {
        document.querySelectorAll('.cell').forEach(c => c.classList.remove('selected-cell', 'cross-highlight'));
        const selectedCell = document.getElementById(`c-${selT}-${selR}`);
        if (selectedCell) {
            selectedCell.classList.add('selected-cell');
            for(let r=0; r<20; r++) {
                const cell = document.getElementById(`c-${selT}-${r}`);
                if (cell) {
                    cell.classList.add('cross-highlight');
                }
            }
            for(let t=0; t<21; t++) {
                const cell = document.getElementById(`c-${t}-${selR}`);
                if (cell) {
                    cell.classList.add('cross-highlight');
                }
            }
        }
        
        document.getElementById('info-cell').innerText = `RPM: ${RPM_AXIS[selR]}, TPS: ${TPS_AXIS[selT]}%`;
        document.getElementById('info-value').innerText = fuelMap[selT][selR];
        
        let min = Infinity, max = -Infinity;
        for (let t = 0; t < 21; t++) {
            for (let r = 0; r < 20; r++) {
                if (fuelMap[t][r] < min) min = fuelMap[t][r];
                if (fuelMap[t][r] > max) max = fuelMap[t][r];
            }
        }
        document.getElementById('info-range').innerText = `${min} - ${max} Œºs`;
    }

    function updateGraph() {
        const overlay = document.getElementById('graph-overlay');
        if (!overlay.classList.contains('active')) return;
        
        const mode = document.getElementById('graph-type').value;
        let traces = [];
        const layout = {
            paper_bgcolor: '#1e1e1e', plot_bgcolor: '#1e1e1e',
            margin: {t:20, l:50, r:20, b:50},
            font: {color: '#888', size: 10},
            xaxis: {gridcolor: '#333', zeroline: false}, yaxis: {gridcolor: '#333', zeroline: false}
        };

        if (mode === '3d') {
            traces = [{
                z: fuelMap, x: RPM_AXIS, y: TPS_AXIS, type: 'surface',
                colorscale: [[0, 'blue'], [0.5, 'green'], [1, 'red']], showscale: false
            }];
            layout.scene = { 
                xaxis: {title:'RPM'}, 
                yaxis: {title:'TPS'}, 
                zaxis: {title:'Fuel'},
                camera: {eye: {x: 1.5, y: 1.5, z: 1.3}}
            };
            layout.margin = {t:10, l:10, r:10, b:10};
        } else if (mode === 'tps') {
            traces = [{
                x: TPS_AXIS, y: fuelMap.map(row => row[selR]),
                type: 'scatter', mode: 'lines+markers', 
                line: {color: '#0078d4', shape: 'linear'}
            }];
            layout.xaxis.title = "TPS (%)"; layout.yaxis.title = "Fuel (Œºs)";
        } else {
            traces = [{
                x: RPM_AXIS, y: fuelMap[selT],
                type: 'scatter', mode: 'lines+markers', 
                line: {color: '#0078d4', shape: 'linear'}
            }];
            layout.xaxis.title = "RPM"; layout.yaxis.title = "Fuel (Œºs)";
        }

        Plotly.newPlot('chart-container', traces, layout, {responsive: true, displayModeBar: false});
    }

    function importFromCSV(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split('\n').filter(l => l.trim());
            lines.shift();
            lines.forEach((line, t) => {
                const values = line.split(',');
                values.shift();
                if (t < 21) {
                    values.forEach((val, r) => {
                        if (r < 20) fuelMap[t][r] = parseInt(val) || 0;
                    });
                }
            });
            renderTable();
            if (document.getElementById('graph-overlay').classList.contains('active')) {
                updateGraph();
            }
        };
        reader.readAsText(file);
    }

    window.onload = () => { 
        initData(); 
        renderTable(); 
        if (document.getElementById('graph-overlay').classList.contains('active')) {
            updateGraph();
        }
    };
</script>
</body>
</html>